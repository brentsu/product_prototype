# è´¢åŠ¡åˆè§„ç®¡ç†ç³»ç»Ÿ - æ•°æ®åº“è®¾è®¡æ–‡æ¡£

**ç‰ˆæœ¬ï¼š** V2.0  
**æ—¥æœŸï¼š** 2025-11-28  
**ä½œè€…ï¼š** å¼€å‘å›¢é˜Ÿ

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æ•°æ®åº“æ¶æ„](#æ•°æ®åº“æ¶æ„)
3. [æ ¸å¿ƒè¡¨è®¾è®¡](#æ ¸å¿ƒè¡¨è®¾è®¡)
4. [å…³ç³»è¡¨è®¾è®¡](#å…³ç³»è¡¨è®¾è®¡)
5. [ä¸šåŠ¡æµç¨‹](#ä¸šåŠ¡æµç¨‹)
6. [æ•°æ®æµè½¬](#æ•°æ®æµè½¬)
7. [ç´¢å¼•ç­–ç•¥](#ç´¢å¼•ç­–ç•¥)
8. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)

---

## ç³»ç»Ÿæ¦‚è¿°

### ä¸šåŠ¡èƒŒæ™¯

è´¢åŠ¡åˆè§„ç®¡ç†ç³»ç»ŸV2æ˜¯ä¸€ä¸ªç”¨äºç®¡ç†é‡‡è´­ã€åˆåŒã€å‘ç¥¨å’ŒæŠ¥å…³å…¨æµç¨‹çš„ç»¼åˆæ€§è´¢åŠ¡ç³»ç»Ÿã€‚ç³»ç»Ÿéœ€è¦è¿½æº¯ä»é‡‡è´­SKUåˆ°æŠ¥å…³å‡ºå£çš„å®Œæ•´é“¾è·¯ï¼Œç¡®ä¿æ¯ä¸ªç¯èŠ‚çš„æ•°æ®å¯è¿½æº¯ã€å¯å®¡è®¡ã€‚

### æ ¸å¿ƒä¸šåŠ¡æµç¨‹

```
é‡‡è´­SKUæ˜ç»† â†’ ç”ŸæˆåˆåŒ â†’ å¼€å…·å‘ç¥¨ â†’ åº“å­˜å‡ºåº“ â†’ æŠ¥å…³å‡ºå£
     â†“           â†“          â†“          â†“          â†“
  purchase_  purchase_  input_    (WMSç³»ç»Ÿ)  stockout_
  sku_detail  contract   invoice              customs_declare
                                              _document
```

### æ•°æ®å…³ç³»é“¾è·¯

```
æŠ¥å…³å•(ç°æœ‰)
   â†“ åŒ¹é… (FIFO)
SKUæ˜ç»† â†â†’ åˆåŒ â†â†’ å‘ç¥¨
   â†“         â†“        â†“
 (1:1)    (1:1æˆ–N:1) (1:N)
```

---

## æ•°æ®åº“æ¶æ„

### ERå›¾æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  purchase_sku   â”‚â”€â”€â”€â”€1:1â”€â†’â”‚ purchase_       â”‚
â”‚  _detail        â”‚         â”‚ contract        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                           â†“
         â”‚                           â”‚
         â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                      â”‚  purchase_ â”‚
         â”‚                      â”‚  contract_ â”‚
         â”‚                      â”‚  item      â”‚
         â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                           â†“
         â”‚                           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â”‚                                      â”‚
    â†“                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ sku_customs_    â”‚                â”‚ contract_    â”‚
â”‚ declare_match   â”‚                â”‚ invoice_     â”‚
â”‚                 â”‚                â”‚ match        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                                  â†“
         â”‚                                  â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â†“          â†“                     â†“          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚stockoutâ”‚  â”‚stockout_customsâ”‚  â”‚  input_  â”‚
â”‚_customsâ”‚  â”‚_declare_       â”‚  â”‚ invoice  â”‚
â”‚_declareâ”‚  â”‚document_       â”‚  â”‚          â”‚
â”‚_documenâ”‚  â”‚aggregated_item â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚t       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¡¨åˆ†ç±»

#### 1. **æ ¸å¿ƒä¸šåŠ¡è¡¨** (4å¼ )
- `purchase_sku_detail` - é‡‡é”€SKUæ˜ç»†è¡¨
- `purchase_contract` - é‡‡é”€åˆåŒä¸»è¡¨
- `purchase_contract_item` - é‡‡é”€åˆåŒæ˜ç»†è¡¨
- `input_invoice` - è¿›é¡¹å‘ç¥¨è¡¨

#### 2. **å…³ç³»åŒ¹é…è¡¨** (3å¼ )
- `sku_contract_match` - SKUæ˜ç»†-åˆåŒåŒ¹é…è¡¨
- `contract_invoice_match` - åˆåŒ-å‘ç¥¨åŒ¹é…è¡¨
- `sku_customs_declare_match` - SKUæ˜ç»†-æŠ¥å…³åŒ¹é…è¡¨

#### 3. **å·²æœ‰æŠ¥å…³è¡¨** (3å¼ )
- `stockout_customs_declare_document` - æŠ¥å…³å•æ®è¡¨
- `stockout_customs_declare_document_item` - æŠ¥å…³æ˜ç»†è¡¨
- `stockout_customs_declare_document_aggregated_item` - æŠ¥å…³èšåˆæ˜ç»†è¡¨

#### 4. **è§†å›¾** (1ä¸ª)
- `v_declare_sku_contract_invoice_mapping` - æ˜ å°„å…³ç³»è§†å›¾

---

## æ ¸å¿ƒè¡¨è®¾è®¡

### 1. purchase_sku_detail (é‡‡é”€SKUæ˜ç»†è¡¨)

**ä½œç”¨ï¼š** ç³»ç»Ÿçš„æ•°æ®èµ·ç‚¹ï¼Œè®°å½•æ‰€æœ‰é‡‡è´­çš„SKUæ˜ç»†ä¿¡æ¯ã€‚

#### å…³é”®å­—æ®µ

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ä¸šåŠ¡å«ä¹‰ |
|--------|------|------|----------|
| `sku_detail_id` | int | ä¸»é”® | SKUæ˜ç»†å”¯ä¸€æ ‡è¯† |
| `sku` | varchar(100) | SKUç¼–ç  | å•†å“è§„æ ¼ç¼–ç  |
| `supplier_code` | varchar(50) | ä¾›åº”å•†ç¼–ç  | ä¾›åº”å•†æ ‡è¯† |
| `quantity` | int | é‡‡è´­æ•°é‡ | åˆåŒçº¦å®šæ•°é‡ |
| `return_qty` | int | é€€è´§æ•°é‡ | å› è´¨é‡ç­‰åŸå› é€€è´§ |
| `available_qty` | int | **æŠ¥å…³å¯ç”¨æ•°é‡** | quantity - return_qty - å·²æŠ¥å…³ |
| `contract_no` | varchar(100) | åˆåŒç¼–å· | å…³è”çš„åˆåŒ |
| `invoice_no` | varchar(100) | å‘ç¥¨å· | å…³è”çš„å‘ç¥¨ |

#### ä¸šåŠ¡è§„åˆ™

1. **å¯ç”¨æ•°é‡è®¡ç®—ï¼š**
   ```
   available_qty = quantity - return_qty - sum(å·²æŠ¥å…³æ•°é‡)
   ```

2. **çŠ¶æ€æµè½¬ï¼š**
   ```
   å¾…å¤„ç† â†’ åˆåŒå¾…ç”Ÿæˆ â†’ åˆåŒç­¾ç½²ä¸­ â†’ åˆåŒç­¾ç½²å®Œæˆ â†’ å·²æŠ¥å…³
   ```

3. **å”¯ä¸€æ€§çº¦æŸï¼š**
   - åŒä¸€ä¸ªSKUåœ¨åŒä¸€ä¸ªåˆåŒä¸‹åªèƒ½æœ‰ä¸€æ¡è®°å½•
   - ç»„åˆå”¯ä¸€ç´¢å¼•ï¼š`uk_sku_contract (sku, contract_no, is_deleted)`

#### ç´¢å¼•è®¾è®¡

```sql
PRIMARY KEY (sku_detail_id)
UNIQUE KEY uk_sku_contract (sku, contract_no, is_deleted)
KEY idx_sku (sku)                          -- æŠ¥å…³åŒ¹é…æŸ¥è¯¢
KEY idx_contract_no (contract_no)          -- åˆåŒå…³è”æŸ¥è¯¢
KEY idx_available_qty (available_qty)      -- å¯ç”¨åº“å­˜æŸ¥è¯¢
KEY idx_is_deleted_create_date (is_deleted, create_date)  -- åˆ—è¡¨åˆ†é¡µ
```

---

### 2. purchase_contract (é‡‡é”€åˆåŒä¸»è¡¨)

**ä½œç”¨ï¼š** è®°å½•é‡‡è´­åˆåŒçš„ä¸»è¦ä¿¡æ¯ï¼Œæ”¯æŒå®¡æ ¸å’Œç”µå­ç­¾ç½²æµç¨‹ã€‚

#### å…³é”®å­—æ®µ

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ä¸šåŠ¡å«ä¹‰ |
|--------|------|------|----------|
| `contract_id` | int | ä¸»é”® | åˆåŒå”¯ä¸€æ ‡è¯† |
| `contract_no` | varchar(100) | åˆåŒç¼–å· | åˆåŒå”¯ä¸€ç¼–å· |
| `supplier_code` | varchar(50) | ä¾›æ–¹ç¼–ç  | ä¾›åº”å•†ç¼–ç  |
| `total_amount_with_tax` | decimal(18,2) | å«ç¨æ€»é¢ | åˆåŒæ€»é‡‘é¢ |
| `status` | varchar(50) | åˆåŒçŠ¶æ€ | æµç¨‹çŠ¶æ€ |
| `audit_status` | varchar(50) | å®¡æ ¸çŠ¶æ€ | å®¡æ ¸æµç¨‹çŠ¶æ€ |
| `signing_status` | varchar(50) | ç­¾ç½²çŠ¶æ€ | ç­¾ç½²æµç¨‹çŠ¶æ€ |
| `invoice_no` | varchar(100) | å…³è”å‘ç¥¨å· | å…³è”çš„å‘ç¥¨ |
| `invoice_relation_type` | varchar(20) | å‘ç¥¨å…³ç³»ç±»å‹ | ä¸€å¯¹ä¸€/å¤šå¯¹ä¸€ |

#### ä¸šåŠ¡è§„åˆ™

1. **çŠ¶æ€æµè½¬ï¼š**
   ```
   å¾…å®¡æ ¸ â†’ å®¡æ ¸ä¸é€šè¿‡/å®¡æ ¸é€šè¿‡ â†’ ç­¾ç½²ä¸­ â†’ ç­¾ç½²å®Œæˆ
   ```

2. **å‘ç¥¨å…³è”è§„åˆ™ï¼š**
   - **ä¸€å¯¹ä¸€ï¼š** ä¸€ä¸ªåˆåŒå¯¹åº”ä¸€å¼ å‘ç¥¨ï¼ˆæœ€å¸¸è§ï¼‰
   - **å¤šå¯¹ä¸€ï¼š** å¤šä¸ªåˆåŒåˆå¹¶å¼€ä¸€å¼ å‘ç¥¨ï¼ˆåŒä¸€ä¾›åº”å•†ï¼‰

3. **é‡‘é¢æ ¡éªŒï¼š**
   - åˆåŒæ€»é‡‘é¢ = sum(åˆåŒæ˜ç»†é‡‘é¢)
   - å¦‚æœå¤šå¯¹ä¸€ï¼Œå‘ç¥¨é‡‘é¢ = sum(å…³è”åˆåŒé‡‘é¢)

#### ç´¢å¼•è®¾è®¡

```sql
PRIMARY KEY (contract_id)
UNIQUE KEY uk_contract_no (contract_no, is_deleted)
KEY idx_supplier_code (supplier_code)      -- ä¾›åº”å•†ç»´åº¦æŸ¥è¯¢
KEY idx_status (status)                    -- çŠ¶æ€ç­›é€‰
KEY idx_invoice_no (invoice_no)            -- å‘ç¥¨å…³è”æŸ¥è¯¢
```

---

### 3. purchase_contract_item (é‡‡é”€åˆåŒæ˜ç»†è¡¨)

**ä½œç”¨ï¼š** è®°å½•åˆåŒçš„æ˜ç»†é¡¹ï¼Œä¸€ä¸ªåˆåŒå¯ä»¥åŒ…å«å¤šä¸ªSKUã€‚

#### å…³é”®å­—æ®µ

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ä¸šåŠ¡å«ä¹‰ |
|--------|------|------|----------|
| `contract_item_id` | int | ä¸»é”® | åˆåŒé¡¹å”¯ä¸€æ ‡è¯† |
| `contract_id` | int | åˆåŒID | å…³è”åˆåŒä¸»è¡¨ |
| `item_no` | varchar(50) | åˆåŒé¡¹å· | å¦‚ï¼š1, 2, 3 |
| `sku` | varchar(100) | SKUç¼–ç  | å•†å“ç¼–ç  |
| `quantity` | int | æ•°é‡ | åˆåŒçº¦å®šæ•°é‡ |
| `sku_detail_id` | int | SKUæ˜ç»†ID | å…³è”SKUæ˜ç»†è¡¨ |

#### ä¸šåŠ¡è§„åˆ™

1. **é¡¹å·è§„åˆ™ï¼š**
   - åŒä¸€åˆåŒä¸‹çš„é¡¹å·å”¯ä¸€ä¸”é€’å¢
   - ç”¨äºæŠ¥å…³åŒ¹é…æ—¶çš„æ˜ç»†è¿½æº¯

2. **é‡‘é¢è®¡ç®—ï¼š**
   ```
   amount_with_tax = quantity * unit_price * (1 + tax_rate)
   ```

---

### 4. input_invoice (è¿›é¡¹å‘ç¥¨è¡¨)

**ä½œç”¨ï¼š** è®°å½•ä¾›åº”å•†å¼€å…·çš„å¢å€¼ç¨ä¸“ç”¨å‘ç¥¨ï¼Œç”¨äºç¨é¢æŠµæ‰£ã€‚

#### å…³é”®å­—æ®µ

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ä¸šåŠ¡å«ä¹‰ |
|--------|------|------|----------|
| `invoice_id` | int | ä¸»é”® | å‘ç¥¨å”¯ä¸€æ ‡è¯† |
| `invoice_code` | varchar(50) | å‘ç¥¨ä»£ç  | ç¨åŠ¡å‘ç¥¨ä»£ç  |
| `invoice_no` | varchar(50) | å‘ç¥¨å·ç  | ç¨åŠ¡å‘ç¥¨å·ç  |
| `amount_with_tax` | decimal(18,2) | ä»·ç¨åˆè®¡ | å‘ç¥¨æ€»é‡‘é¢ |
| `status` | varchar(50) | å‘ç¥¨çŠ¶æ€ | å¾…è®¤è¯/å·²è®¤è¯/å·²ä½œåºŸ |
| `related_contract_count` | int | å…³è”åˆåŒæ•°é‡ | å¤šå¯¹ä¸€åœºæ™¯ |
| `related_contracts` | varchar(500) | å…³è”åˆåŒåˆ—è¡¨ | JSONæˆ–é€—å·åˆ†éš” |

#### ä¸šåŠ¡è§„åˆ™

1. **å”¯ä¸€æ€§ï¼š**
   - å‘ç¥¨ä»£ç +å‘ç¥¨å·ç  å”¯ä¸€
   - `uk_invoice_code_no (invoice_code, invoice_no, is_deleted)`

2. **è®¤è¯æµç¨‹ï¼š**
   ```
   å¾…è®¤è¯ â†’ å·²è®¤è¯ â†’ å¯æŠµæ‰£
   ```

3. **å…³è”è§„åˆ™ï¼š**
   - ä¸€å¯¹ä¸€ï¼š`related_contract_count = 1`
   - å¤šå¯¹ä¸€ï¼š`related_contract_count > 1`

---

## å…³ç³»è¡¨è®¾è®¡

### 1. sku_contract_match (SKUæ˜ç»†-åˆåŒåŒ¹é…è¡¨)

**ä½œç”¨ï¼š** è®°å½•SKUæ˜ç»†ä¸åˆåŒçš„å…³è”å…³ç³»ï¼ˆé€šå¸¸æ˜¯ä¸€å¯¹ä¸€ï¼‰ã€‚

#### å…³é”®å­—æ®µ

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `match_id` | int | ä¸»é”® |
| `sku_detail_id` | int | SKUæ˜ç»†ID |
| `contract_id` | int | åˆåŒID |
| `contract_item_id` | int | åˆåŒé¡¹ID |
| `matched_quantity` | int | åŒ¹é…æ•°é‡ |

#### ä¸šåŠ¡è§„åˆ™

- ä¸€ä¸ªSKUæ˜ç»†å¯¹åº”ä¸€ä¸ªåˆåŒé¡¹
- è‡ªåŠ¨åŒ¹é…ï¼šåœ¨åˆåŒç”Ÿæˆæ—¶è‡ªåŠ¨åˆ›å»ºå…³è”
- å”¯ä¸€çº¦æŸï¼š`uk_sku_contract_item (sku_detail_id, contract_item_id)`

---

### 2. contract_invoice_match (åˆåŒ-å‘ç¥¨åŒ¹é…è¡¨)

**ä½œç”¨ï¼š** è®°å½•åˆåŒä¸å‘ç¥¨çš„å…³è”å…³ç³»ï¼Œæ”¯æŒä¸€å¯¹ä¸€å’Œå¤šå¯¹ä¸€ã€‚

#### å…³é”®å­—æ®µ

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `match_id` | int | ä¸»é”® |
| `contract_id` | int | åˆåŒID |
| `invoice_id` | int | å‘ç¥¨ID |
| `relation_type` | varchar(20) | å…³ç³»ç±»å‹ï¼šä¸€å¯¹ä¸€/å¤šå¯¹ä¸€ |
| `amount_match_status` | varchar(50) | é‡‘é¢åŒ¹é…çŠ¶æ€ |

#### ä¸šåŠ¡è§„åˆ™

1. **ä¸€å¯¹ä¸€å…³ç³»ï¼š**
   ```
   åˆåŒé‡‘é¢ = å‘ç¥¨é‡‘é¢
   amount_match_status = 'åŒ¹é…'
   ```

2. **å¤šå¯¹ä¸€å…³ç³»ï¼š**
   ```
   sum(åˆåŒé‡‘é¢) = å‘ç¥¨é‡‘é¢
   åŒä¸€ä¾›åº”å•†ï¼ŒåŒä¸€æ—¶é—´æ®µ
   ```

#### åœºæ™¯ç¤ºä¾‹

```sql
-- åœºæ™¯1ï¼šä¸€å¯¹ä¸€
åˆåŒHT001 (Â¥100,000) â†’ å‘ç¥¨FP001 (Â¥100,000)

-- åœºæ™¯2ï¼šå¤šå¯¹ä¸€
åˆåŒHT002 (Â¥60,000)  â†˜
åˆåŒHT003 (Â¥40,000)  â†’ å‘ç¥¨FP002 (Â¥100,000)
```

---

### 3. sku_customs_declare_match (SKUæ˜ç»†-æŠ¥å…³åŒ¹é…è¡¨)

**ä½œç”¨ï¼š** è®°å½•SKUæ˜ç»†ä¸æŠ¥å…³å•çš„åŒ¹é…å…³ç³»ï¼Œå®ç°FIFOå‡ºåº“ç­–ç•¥ã€‚

#### å…³é”®å­—æ®µ

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ä¸šåŠ¡å«ä¹‰ |
|--------|------|------|----------|
| `match_id` | int | ä¸»é”® | åŒ¹é…å”¯ä¸€æ ‡è¯† |
| `sku_detail_id` | int | SKUæ˜ç»†ID | æ¥æºSKU |
| `declare_document_id` | int | æŠ¥å…³å•ID | æŠ¥å…³å• |
| `declare_document_aggregated_item_id` | int | æŠ¥å…³èšåˆé¡¹ID | æŠ¥å…³èšåˆé¡¹ |
| `g_no` | int | æŠ¥å…³é¡¹å· | æŠ¥å…³å•ä¸­çš„é¡¹å· |
| `declare_quantity` | int | æŠ¥å…³æ•°é‡ | æœ¬æ¬¡æŠ¥å…³æ•°é‡ |
| `matched_quantity` | int | åŒ¹é…æ•°é‡ | ä»æœ¬SKUåŒ¹é…çš„æ•°é‡ |
| `available_quantity_before_match` | int | åŒ¹é…å‰å¯ç”¨ | è®°å½•å¿«ç…§ |
| `available_quantity_after_match` | int | åŒ¹é…åå¯ç”¨ | è®°å½•å¿«ç…§ |
| `match_status` | varchar(50) | åŒ¹é…çŠ¶æ€ | å®Œå…¨åŒ¹é…/éƒ¨åˆ†åŒ¹é… |
| `match_strategy` | varchar(50) | åŒ¹é…ç­–ç•¥ | FIFO/LIFO |
| `match_order` | int | åŒ¹é…é¡ºåº | å¤šæ˜ç»†åŒ¹é…æ—¶çš„åºå· |

#### ä¸šåŠ¡è§„åˆ™

1. **FIFOåŒ¹é…ç­–ç•¥ï¼š**
   ```sql
   -- æŒ‰SKUæ˜ç»†åˆ›å»ºæ—¶é—´æ’åºï¼Œä¼˜å…ˆä½¿ç”¨æœ€æ—©çš„åº“å­˜
   SELECT * FROM purchase_sku_detail 
   WHERE sku = 'ç›®æ ‡SKU' 
     AND contract_status = 'ç­¾ç½²å®Œæˆ'
     AND available_qty > 0
   ORDER BY create_date ASC;
   ```

2. **åŒ¹é…åœºæ™¯ï¼š**

   **åœºæ™¯Aï¼šå•æ˜ç»†å®Œå…¨åŒ¹é…**
   ```
   æŠ¥å…³éœ€æ±‚: LC788786-P3010-S 50ä»¶
   SKU001: å¯ç”¨ 100ä»¶
   
   åŒ¹é…ç»“æœ:
   - matched_quantity = 50
   - match_status = 'å®Œå…¨åŒ¹é…'
   - match_order = 1
   ```

   **åœºæ™¯Bï¼šå¤šæ˜ç»†åŒ¹é…ï¼ˆFIFOï¼‰**
   ```
   æŠ¥å…³éœ€æ±‚: LC788786-P3010-XL 120ä»¶
   SKU001: å¯ç”¨ 100ä»¶ (2025-11-21åˆ›å»º)
   SKU003: å¯ç”¨ 100ä»¶ (2025-11-22åˆ›å»º)
   
   FIFOåŒ¹é…ç»“æœ:
   ç¬¬1æ¡: SKU001åŒ¹é…100ä»¶, match_order=1
   ç¬¬2æ¡: SKU003åŒ¹é… 20ä»¶, match_order=2
   ```

   **åœºæ™¯Cï¼šéƒ¨åˆ†åŒ¹é…**
   ```
   æŠ¥å…³éœ€æ±‚: LC788786-P3010-2XL 100ä»¶
   SKU002: å¯ç”¨  80ä»¶ (é€€è´§20ä»¶)
   
   åŒ¹é…ç»“æœ:
   - matched_quantity = 80
   - match_status = 'éƒ¨åˆ†åŒ¹é…'
   - éœ€è¦äººå·¥ä»‹å…¥å¤„ç†ç¼ºå£
   ```

3. **å¯ç”¨æ•°é‡æ›´æ–°ï¼š**
   ```
   SKUæ˜ç»†.available_qty = SKUæ˜ç»†.available_qty - matched_quantity
   ```

#### ç´¢å¼•è®¾è®¡

```sql
PRIMARY KEY (match_id)
KEY idx_sku_detail_id (sku_detail_id)              -- SKUç»´åº¦æŸ¥è¯¢
KEY idx_declare_document_id (declare_document_id)  -- æŠ¥å…³å•ç»´åº¦æŸ¥è¯¢
KEY idx_sku (sku)                                  -- SKUåŒ¹é…
KEY idx_match_date (match_date)                    -- æ—¶é—´èŒƒå›´æŸ¥è¯¢
KEY idx_invoice_no (invoice_no)                    -- å‘ç¥¨è¿½æº¯
```

---

## ä¸šåŠ¡æµç¨‹

### æµç¨‹1ï¼šé‡‡è´­åˆ°åˆåŒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é‡‡è´­éœ€æ±‚äº§ç”Ÿ â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å½•å…¥SKUæ˜ç»†          â”‚
â”‚ (purchase_sku_detail)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”Ÿæˆé‡‡è´­åˆåŒ         â”‚
â”‚ (purchase_contract)  â”‚
â”‚ (purchase_contract_  â”‚
â”‚  item)               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ›å»ºSKU-åˆåŒåŒ¹é…     â”‚
â”‚ (sku_contract_match) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆåŒå®¡æ ¸æµç¨‹         â”‚
â”‚ çŠ¶æ€:å¾…å®¡æ ¸â†’ç­¾ç½²ä¸­â†’  â”‚
â”‚      ç­¾ç½²å®Œæˆ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æµç¨‹2ï¼šåˆåŒåˆ°å‘ç¥¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆåŒç­¾ç½²å®Œæˆ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¾›åº”å•†å¼€å…·å‘ç¥¨ â”‚
â”‚ (input_invoice)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
    â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚ åˆ¤æ–­   â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚
    â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                â”‚
    â†“                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ä¸€å¯¹ä¸€ â”‚      â”‚ å¤šå¯¹ä¸€   â”‚
â”‚å…³ç³»   â”‚      â”‚ å…³ç³»     â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜      â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
    â”‚              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ›å»ºåˆåŒ-å‘ç¥¨åŒ¹é…       â”‚
â”‚ (contract_invoice_match)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æµç¨‹3ï¼šå‡ºåº“æŠ¥å…³ï¼ˆæ ¸å¿ƒæµç¨‹ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WMSç³»ç»Ÿå‡ºåº“è¯·æ±‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŠ¥å…³å•ç”Ÿæˆ          â”‚
â”‚ (stockout_customs_  â”‚
â”‚  declare_document)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èšåˆç›¸åŒå•†å“        â”‚
â”‚ (aggregated_item)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è§¦å‘è‡ªåŠ¨åŒ¹é…        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FIFOåŒ¹é…ç®—æ³•                 â”‚
â”‚ 1. æŒ‰SKUæŸ¥æ‰¾å¯ç”¨æ˜ç»†         â”‚
â”‚ 2. æŒ‰create_date ASCæ’åº     â”‚
â”‚ 3. ä¾æ¬¡æ‰£å‡ç›´åˆ°æ»¡è¶³æŠ¥å…³æ•°é‡  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
    â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚ åˆ¤æ–­   â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚
    â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     â”‚
    â†“                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚å®Œå…¨åŒ¹é…â”‚          â”‚ éƒ¨åˆ†åŒ¹é… â”‚
â”‚       â”‚          â”‚          â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜          â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
    â”‚                  â”‚
    â”‚                  â†“
    â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          â”‚ äººå·¥ä»‹å…¥å¤„ç† â”‚
    â”‚          â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ›å»ºSKU-æŠ¥å…³åŒ¹é…è®°å½•        â”‚
â”‚ (sku_customs_declare_match) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ›´æ–°SKUæ˜ç»†å¯ç”¨æ•°é‡         â”‚
â”‚ available_qty -= matched_qtyâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•°æ®æµè½¬

### æ•°æ®æµè½¬å›¾

```
é‡‡è´­SKUæ˜ç»†
  â†“ (ç”ŸæˆåˆåŒ)
  â”œâ”€â†’ åˆåŒä¸»è¡¨
  â””â”€â†’ åˆåŒæ˜ç»†è¡¨
       â†“ (å…³è”å‘ç¥¨)
       â”œâ”€â†’ å‘ç¥¨è¡¨
       â””â”€â†’ åˆåŒ-å‘ç¥¨åŒ¹é…è¡¨
            â†“
         (å‡ºåº“æŠ¥å…³)
            â†“
       â”œâ”€â†’ æŠ¥å…³å•æ®è¡¨
       â”œâ”€â†’ æŠ¥å…³èšåˆæ˜ç»†è¡¨
       â””â”€â†’ SKU-æŠ¥å…³åŒ¹é…è¡¨
```

### å…³é”®æŒ‡æ ‡è¿½æº¯

**é—®é¢˜ï¼šæŸæ‰¹æ¬¡å•†å“çš„å®Œæ•´é“¾è·¯æ˜¯ä»€ä¹ˆï¼Ÿ**

```sql
-- ä»æŠ¥å…³å•åå‘è¿½æº¯
SELECT 
    -- æŠ¥å…³ä¿¡æ¯
    cd.declare_document_no AS 'æŠ¥å…³å•å·',
    cd.export_date AS 'å‡ºå£æ—¥æœŸ',
    
    -- SKUä¿¡æ¯
    sdm.sku AS 'SKUç¼–ç ',
    psd.product_name AS 'å•†å“åç§°',
    sdm.matched_quantity AS 'æŠ¥å…³æ•°é‡',
    
    -- åˆåŒä¿¡æ¯
    pc.contract_no AS 'åˆåŒç¼–å·',
    pc.supplier_name AS 'ä¾›åº”å•†',
    sdm.contract_item_no AS 'åˆåŒé¡¹å·',
    
    -- å‘ç¥¨ä¿¡æ¯
    ii.invoice_no AS 'å‘ç¥¨å·',
    ii.amount_with_tax AS 'å‘ç¥¨é‡‘é¢',
    ii.invoice_date AS 'å¼€ç¥¨æ—¥æœŸ'
    
FROM sku_customs_declare_match sdm
LEFT JOIN stockout_customs_declare_document cd 
    ON sdm.declare_document_id = cd.declare_document_id
LEFT JOIN purchase_sku_detail psd 
    ON sdm.sku_detail_id = psd.sku_detail_id
LEFT JOIN purchase_contract pc 
    ON sdm.contract_id = pc.contract_id
LEFT JOIN input_invoice ii 
    ON sdm.invoice_no = ii.invoice_no
WHERE cd.declare_document_no = 'FBA194287Y1B'
ORDER BY sdm.match_order;
```

**ç»“æœç¤ºä¾‹ï¼š**
| æŠ¥å…³å•å· | SKU | æŠ¥å…³æ•°é‡ | åˆåŒç¼–å· | åˆåŒé¡¹å· | å‘ç¥¨å· | ä¾›åº”å•† |
|----------|-----|----------|----------|----------|--------|--------|
| FBA194287Y1B | LC788786-P3010-XL | 100 | HT202511210001 | 1 | 25352000 | å¹¿å·XXæœé¥° |
| FBA194287Y1B | LC788786-P3010-XL |  20 | HT202511210002 | 1 | 25352001 | å¹¿å·XXæœé¥° |
| FBA194287Y1B | LC788786-P3010-2XL|  80 | HT202511210003 | 1 | 25352001 | å¹¿å·XXæœé¥° |

---

## ç´¢å¼•ç­–ç•¥

### 1. ä¸»é”®ç´¢å¼•

æ‰€æœ‰è¡¨éƒ½æœ‰è‡ªå¢ä¸»é”®ï¼š
```sql
PRIMARY KEY (xxx_id)
```

### 2. å”¯ä¸€ç´¢å¼•

é˜²æ­¢é‡å¤æ•°æ®ï¼š
```sql
-- SKUæ˜ç»†ï¼šåŒä¸€SKUåœ¨åŒä¸€åˆåŒä¸‹å”¯ä¸€
UNIQUE KEY uk_sku_contract (sku, contract_no, is_deleted)

-- åˆåŒï¼šåˆåŒç¼–å·å”¯ä¸€
UNIQUE KEY uk_contract_no (contract_no, is_deleted)

-- å‘ç¥¨ï¼šå‘ç¥¨ä»£ç +å·ç å”¯ä¸€
UNIQUE KEY uk_invoice_code_no (invoice_code, invoice_no, is_deleted)
```

### 3. å¤–é”®å…³è”ç´¢å¼•

ç”¨äºJOINæŸ¥è¯¢ä¼˜åŒ–ï¼š
```sql
-- æŠ¥å…³åŒ¹é…è¡¨
KEY idx_sku_detail_id (sku_detail_id)
KEY idx_declare_document_id (declare_document_id)
KEY idx_contract_id (contract_id)
```

### 4. ä¸šåŠ¡æŸ¥è¯¢ç´¢å¼•

ç”¨äºé«˜é¢‘æŸ¥è¯¢ä¼˜åŒ–ï¼š
```sql
-- çŠ¶æ€ç­›é€‰
KEY idx_status (status)
KEY idx_contract_status (contract_status)

-- æ—¶é—´èŒƒå›´æŸ¥è¯¢
KEY idx_is_deleted_create_date (is_deleted, create_date)

-- å¯ç”¨åº“å­˜æŸ¥è¯¢
KEY idx_available_qty (available_qty)
```

### 5. ç»„åˆç´¢å¼•å»ºè®®

```sql
-- æŠ¥å…³åŒ¹é…ï¼šæŒ‰SKU+æ—¥æœŸæŸ¥è¯¢
ALTER TABLE sku_customs_declare_match 
ADD KEY idx_sku_match_date (sku, match_date);

-- SKUæ˜ç»†ï¼šæŒ‰ä¾›åº”å•†+çŠ¶æ€æŸ¥è¯¢
ALTER TABLE purchase_sku_detail 
ADD KEY idx_supplier_status (supplier_code, contract_status);
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. åˆ†åŒºç­–ç•¥

å¯¹äºæ•°æ®é‡å¤§çš„å†å²è¡¨ï¼Œå»ºè®®æŒ‰æ—¶é—´åˆ†åŒºï¼š

```sql
-- æŠ¥å…³åŒ¹é…è¡¨æŒ‰å¹´åˆ†åŒº
ALTER TABLE sku_customs_declare_match 
PARTITION BY RANGE (YEAR(match_date)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

### 2. å½’æ¡£ç­–ç•¥

å®šæœŸå½’æ¡£å†å²æ•°æ®ï¼š

```sql
-- åˆ›å»ºå½’æ¡£è¡¨
CREATE TABLE sku_customs_declare_match_archive 
LIKE sku_customs_declare_match;

-- å½’æ¡£2å¹´å‰çš„æ•°æ®
INSERT INTO sku_customs_declare_match_archive
SELECT * FROM sku_customs_declare_match
WHERE match_date < DATE_SUB(NOW(), INTERVAL 2 YEAR);

-- åˆ é™¤å·²å½’æ¡£æ•°æ®
DELETE FROM sku_customs_declare_match
WHERE match_date < DATE_SUB(NOW(), INTERVAL 2 YEAR);
```

### 3. ç»Ÿè®¡ä¿¡æ¯ç»´æŠ¤

å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼š

```sql
-- åˆ†æè¡¨
ANALYZE TABLE purchase_sku_detail;
ANALYZE TABLE sku_customs_declare_match;

-- ä¼˜åŒ–è¡¨
OPTIMIZE TABLE purchase_sku_detail;
```

### 4. æ…¢æŸ¥è¯¢ä¼˜åŒ–

```sql
-- å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2;

-- åˆ†ææ…¢æŸ¥è¯¢
-- æŸ¥çœ‹ slow_query_log æ–‡ä»¶
```

### 5. è¯»å†™åˆ†ç¦»

å¯¹äºé«˜å¹¶å‘åœºæ™¯ï¼š
- ä¸»åº“ï¼šå†™æ“ä½œï¼ˆINSERT, UPDATE, DELETEï¼‰
- ä»åº“ï¼šè¯»æ“ä½œï¼ˆSELECTï¼‰
- ä½¿ç”¨è§†å›¾ç®€åŒ–ä»åº“æŸ¥è¯¢

---

## é™„å½•

### A. æ•°æ®å­—å…¸

å®Œæ•´çš„å­—æ®µè¯´æ˜è¯·å‚è€ƒ `finance_compliance_tables.sql` ä¸­çš„æ³¨é‡Šã€‚

### B. ç¤ºä¾‹æ•°æ®

```sql
-- æ’å…¥ç¤ºä¾‹SKUæ˜ç»†
INSERT INTO purchase_sku_detail (
    sku, product_name, supplier_code, supplier_name,
    purchase_company_id, purchase_company_name,
    quantity, return_qty, available_qty,
    unit_price, total_amount, contract_no, contract_status
) VALUES
('LC788786-P3010-XL', 'å¥³å£«å¤–å¥—', 'SUP001', 'å¹¿å·XXæœé¥°æœ‰é™å…¬å¸',
 1, 'æ·±åœ³XXè¿›å‡ºå£æœ‰é™å…¬å¸',
 100, 0, 100,
 150.60, 15060.00, 'HT202511210001', 'ç­¾ç½²å®Œæˆ');
```

### C. å¸¸ç”¨æŸ¥è¯¢æ¨¡æ¿

#### C.1 æŸ¥è¯¢SKUçš„å¯ç”¨åº“å­˜

```sql
SELECT 
    sku,
    product_name,
    SUM(available_qty) AS total_available
FROM purchase_sku_detail
WHERE is_deleted = 0
  AND contract_status = 'ç­¾ç½²å®Œæˆ'
GROUP BY sku, product_name
HAVING total_available > 0;
```

#### C.2 æŸ¥è¯¢åˆåŒçš„å‘ç¥¨å…³è”æƒ…å†µ

```sql
SELECT 
    pc.contract_no,
    pc.supplier_name,
    pc.total_amount_with_tax,
    ii.invoice_no,
    ii.amount_with_tax,
    cim.relation_type,
    cim.amount_match_status
FROM purchase_contract pc
LEFT JOIN contract_invoice_match cim ON pc.contract_id = cim.contract_id
LEFT JOIN input_invoice ii ON cim.invoice_id = ii.invoice_id
WHERE pc.is_deleted = 0;
```

#### C.3 æŸ¥è¯¢æŠ¥å…³å•çš„åŒ¹é…è¯¦æƒ…

```sql
SELECT 
    cd.declare_document_no,
    cda.g_no,
    cda.customs_declare_cn,
    cda.qty AS declare_qty,
    sdm.sku,
    sdm.matched_quantity,
    sdm.match_status,
    pc.contract_no,
    ii.invoice_no
FROM stockout_customs_declare_document cd
JOIN stockout_customs_declare_document_aggregated_item cda 
    ON cd.declare_document_id = cda.declare_document_id
LEFT JOIN sku_customs_declare_match sdm 
    ON cda.declare_document_aggregated_item_id = sdm.declare_document_aggregated_item_id
LEFT JOIN purchase_contract pc 
    ON sdm.contract_id = pc.contract_id
LEFT JOIN input_invoice ii 
    ON sdm.invoice_no = ii.invoice_no
WHERE cd.declare_document_no = 'FBA194287Y1B'
ORDER BY cda.g_no, sdm.match_order;
```

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** V2.0  
**æœ€åæ›´æ–°ï¼š** 2025-11-28  
**ç»´æŠ¤è€…ï¼š** å¼€å‘å›¢é˜Ÿ

